# 建模手to编程手 第2问 交付文档

## 题目背景
![alt text](image.png)

## 模型假设
**假设1：** 相邻板凳之间不考虑碰撞，因为相邻的板凳在空间Z轴上显然不在同一个平面，否则会导致在一开始模型就会由于相邻板凳之间的碰撞而停止盘入。

## 模型参数设定

**固定参数：** 

- 与第一问中的各固定参数相同，没有变化

**需要求解的参数：**

- 第i个矩形板凳的四个角点坐标$(x_{i1},y_{i1}),(x_{i2},y_{i2}),(x_{i3},y_{i3}),(x_{i4},y_{i4})$ (i=1,2,3,...,223)
- 发生碰撞的时间$t_{target}$

## 模型计算流程

### 总体思想：我们的目的是为了检测板凳之间是否会在盘入过程中发生碰撞并检测具体的碰撞时间，这是一个2D平面上的矩形碰撞问题。通常来讲，解决这类问题的方法是采用分离轴定理SAT，对两个可能发生碰撞的矩形之间检测是否存在至少一个分离轴，若存在分离轴则说明为发生碰撞。

#### **步骤1：由第一问中的各时刻坐标计算出每个板凳在各时刻的四个角点坐标** 

首先我们在第一问中已经求得了每个板凳的前后两把手的直角坐标系坐标。对于第 `i` 节板凳，其前后两把手（节点）的坐标分别为 $P_{i-1}=(x_{i-1},y_{i-1})$ 与 $P_i=(x_i,y_i)$。

##### a. 计算板凳中心点坐标 ($\vec{C}_i$)

板凳的几何中心即为其前后两个把手连线的中点。因此，第 `i` 节板凳中心的坐标为：
$$\vec{C}_i = \left(\frac{x_{i-1}+x_i}{2}, \frac{y_{i-1}+y_i}{2}\right)$$

##### b. 定义方向向量

为了确定矩形的朝向，我们需要两个相互垂直的单位向量：一个沿着板凳的长度方向，一个沿着板凳的宽度方向。

1.  **长度方向的单位向量 ($\vec{u}_L$)**:
    这个向量与板凳前后两把手的连线方向一致。
    -   方向向量：$\vec{d}_L = P_i - P_{i-1} = (x_i - x_{i-1}, y_i - y_{i-1})$
    -   单位向量：$\vec{u}_L = \frac{\vec{d}_L}{|\vec{d}_L|}$。设 $\vec{u}_L = (u_{Lx}, u_{Ly})$。

2.  **宽度方向的单位向量 ($\vec{u}_W$)**:
    该向量是长度方向向量的法向量，可以通过交换分量并给其中一个取反得到。
    -   单位向量：$\vec{u}_W = (-u_{Ly}, u_{Lx})$

##### c. 定义板凳尺寸

1.  **板凳半长 ($h_L$)**:
    这里的长度应使用板凳的**物理总长度**
    -   对于龙头 (i=1): $h_L = \frac{3.41\text{m}}{2} = 1.705\text{m}$
    -   对于龙身和龙尾 (i≥2): $h_L = \frac{2.2\text{m}}{2} = 1.1\text{m}$

2.  **板凳半宽 ($h_W$)**:
    -   $h_W = \frac{\text{WIDTH}}{2} = \frac{0.3\text{m}}{2} = 0.15\text{m}$

##### d. 计算四个角点坐标

有了中心点、两个方向向量和半长/半宽，我们就可以通过向量加减法得到四个角点 $V_1, V_2, V_3, V_4$ 的坐标。其原理是：$角点坐标 = 中心点坐标 ± 长度方向位移 ± 宽度方向位移$。

-   $\vec{V}_1 = \vec{C}_i + \vec{u}_L \cdot h_L + \vec{u}_W \cdot h_W$
-   $\vec{V}_2 = \vec{C}_i - \vec{u}_L \cdot h_L + \vec{u}_W \cdot h_W$
-   $\vec{V}_3 = \vec{C}_i - \vec{u}_L \cdot h_L - \vec{u}_W \cdot h_W$
-   $\vec{V}_4 = \vec{C}_i + \vec{u}_L \cdot h_L - \vec{u}_W \cdot h_W$

通过以上计算，在模拟的每一时刻，我们都可以计算得到每一个板凳的四个角点坐标

#### **步骤2：利用分离轴定理SAT判断内外圈板凳是否碰撞**

分离轴定理指的是对于两个凸多边形（在该题中为矩形），若能找到一条轴，使得两个多边形在该轴上的投影不重叠，则说明这两个多边形不相交

![alt text](image-1.png)

通常来讲，要解决该问题分为三个步骤：

- 分离轴的选取
- 投影的计算
- 判断投影是否重叠

对于上述三个问题，我们分开讨论：

##### 1. 分离轴的选取

通常来讲，分离轴一般可以尝试以两个多边形各条边的法向量方向进行选取，在该题中讨论两个矩形时，由于矩形的对边是平行的，因此对边的法向量方向相同，即最多考虑2*2=4种分离轴的选取方向。

##### 2. 投影的计算

投影的计算是分离轴定理中的核心数学步骤。其本质是**将二维的矩形顶点坐标，映射到一维的轴上**，从而得到一个可以比较大小和范围的区间。

##### a. 数学原理：向量点积

假设我们有一个顶点（由位置向量表示）$\vec{v} = (v_x, v_y)$，和一个表示分离轴方向的单位向量 $\vec{a} = (a_x, a_y)$。

顶点 $\vec{v}$ 在轴 $\vec{a}$ 上的投影 `proj` 是一个标量，其计算公式为：
$$proj = \vec{v} \cdot \vec{a} = v_x a_x + v_y a_y$$


##### b. 计算流程

对于一个给定的矩形（由四个顶点 $V_1, V_2, V_3, V_4$ 定义）和一条选定的分离轴 $\vec{a}$，计算其投影区间的步骤如下：

1.  **分别计算每个顶点的投影**：
    对矩形的全部4个顶点，都执行与轴向量 $\vec{a}$ 的点积运算，得到4个标量值。
    -   $p_1 = \vec{V}_1 \cdot \vec{a}$
    -   $p_2 = \vec{V}_2 \cdot \vec{a}$
    -   $p_3 = \vec{V}_3 \cdot \vec{a}$
    -   $p_4 = \vec{V}_4 \cdot \vec{a}$

2.  **确定投影区间**:
    找出这4个标量值中的最小值 min 和最大值 max。
    -   $min = Minimum(p_1, p_2, p_3, p_4)$
    -   $max = Maximum(p_1, p_2, p_3, p_4)$

这个区间 $[min, max]$ 就是该矩形在轴 $\vec{a}$ 上的完整投影，对需要判断碰撞的两个矩形都执行以上操作，我们就能得到它们在同一条轴上的两个投影区间

##### 3. 判断投影是否重叠

对于两个矩形A，B，我们假设其在投影上的最小值与最大值区间分别为$[minA,maxA],[minB,maxB]$，若满足如下两个条件其中之一，则说明AB投影不重叠（即要么A投影完全在B投影的左边，要么A投影完全在B投影的右边）：

- minA>maxB
- minB>maxA

对两个矩形的四个候选分离轴分别进行重叠判定，若存在其中一个分离轴上满足上述两个条件之一，则说明两矩形未发生碰撞，可直接停止判断这一对矩形，直接进入下一对矩形的判断。

**显然，我们对A板凳进行碰撞检测时，并不需要遍历所有的其他板凳，因为碰撞只可能最先发生在相邻圈数的板凳之间，并且一定是在该板凳与更内圈的板凳之间发生碰撞（因为越向内空间越狭小），因此在对A板凳进行碰撞检测时，假设A板凳前把手的极角为$\theta_A$，那么我们只需要关注把手极角范围在$[\theta_A-3\pi,\theta_A]$之间的其他板凳即可 ($3\pi$是为了拓宽检测边界避免漏掉碰撞)**

#### **步骤3：检测到碰撞之后进一步小步长搜索**

首先使用第一问中算出来的以1s为步长的位置坐标数据进行碰撞检测，假设我们检测出在第X秒未发生碰撞而在第X+1秒就发生了碰撞，那么我们就需要在[X秒,X+1秒]这个时间区间内减少步长，比如以0.1s作为步长进行搜索；同理在搜索到区间[X.Y秒，X.Y+1秒]之后，继续减少步长，以0.01s作为搜索步长……

以此类推，精度要求到0.0001s

## 结果数据需求
- 发生碰撞的具体时间，精度到0.0001s
- 发生碰撞时所有把手的位置坐标与速度情况

## 模型求解方法需求

还是和之前的一样，使用numba做计算加速，如果可以的话可以考虑一下joblib并行化求解。