# 建模手to编程手 第4问 交付文档

## 题目背景
![alt text](image.png)
## 模型假设

- 为简化讨论，我们假设板凳龙开始进行S型调头与结束S型调头的位置均为螺线与半径为4.5m的圆形调头区域的交点
- 由于不论是先走大圆弧还是先走小圆弧，对于最终结果而言，均为等价的，因此我们假设先走大圆弧，即$R_1:R_2=2:1$

## 模型参数设定

### **固定参数：**

- 盘入螺线螺距 p=1.7m
- 龙头前把手沿螺线前进的速度 $v_0=1m/s$
- 固定的开始调头极角$\theta_{entry}$
- 固定的结束调头极角$\theta_{end}$
- 大圆弧与小圆弧的比值$R_1:R_2=2:1$

### **需要求解的参数：**

- 大圆弧所对的圆心角$\alpha_1$
- 小圆弧所对的圆心角$\alpha_2$
- 大圆弧的圆心$C_1=(x_1,y_1)$
- 小圆弧的圆心$C_2=(x_2,y_2)$
- 总弧长$L=L_1+L_2$

## 模型计算流程

### 总体思想：我们假设板凳龙开始调头与结束掉头的位置均为固定的（即为调头边界与螺线交点），决策变量为两个圆弧所对应的圆心角，目标函数为最小化两段圆弧的弧长之和$L=L_1+L_2=\frac{\alpha_1}{2\pi}\cdot 2\pi R_1+\frac{\alpha_2}{2\pi}\cdot 2\pi R_2=\alpha_1 R_1+\alpha_2 R_2$，约束条件为出入调头区域的极角以及两个圆弧的相切关系还有两个圆弧的半径之比关系

### **步骤1：确定边界条件**

- 首先通过圆形调头区域方程:$x^2+y^2=4.5^2=(rcos\theta)^2+(rsin\theta)^2=4.5^2$与螺线方程$r=b\theta=\frac{1.7}{2\pi}\theta$联立可以计算出开始调头与结束掉头的极角$\theta_{entry},\theta_{end}$
- 计算出在开始调头的极角$\theta_{entry}$下，螺线的极坐标$(r_{entry},\theta_{entry})$，进而得到其直角坐标$(x_{entry},y_{entry})$；对结束调头也同理，计算出$(r_{end},\theta_{end})$的直角坐标$(x_{end},y_{end})$。
- 计算出$\theta_{entry}处与\theta_{end}处的法向量\vec{N}_{entry},\vec{N}_{end}$，显然，由于相切条件的限制，圆弧的圆心必然在方向量方向上；同时又由于我们这里假设先大圆弧再小圆弧，因此就是大圆弧圆心$C_1=(x_1,y_1)$在法向量$\vec{N}_{entry}$的方向上，小圆弧圆心$C_2=(x_2,y_2)$在法向量$\vec{N}_{end}$的方向上。

### **步骤2：推导出弧长不变性**

由步骤一，我们推导出了切点必然处在螺线与圆形调头边界的交点处，那么可以导出：**开始调头的位置与结束调头的位置恒定**

同时，由题目所给出的调头曲线与螺线相切，我们可以导出：调头曲线的圆心必然在切点法向量方向上，又由于两圆相切，故有：$|C_1-C_2|=R_1+R_2$，如图所示：
![alt text](image-1.png)
**圆心位置与圆心角均唯一，在给定半径比例、与螺线相切、开始调头与结束调头位置三大条件的情况下，总弧长唯一，不变**

### 步骤3：直接求解几何参数与路径长度

在步骤2中，我们建立了一个完整的几何约束方程组。经过代数化简，这个方程组可以被归结为一个可以直接求解的标准方程，因此我们无需使用迭代式的通用数值求解器。

#### a. 推导求解方程

我们的主方程是描述两圆弧相切的约束：
$$|\vec{C}_1 - \vec{C}_2|^2 = (R_1 + R_2)^2$$

1.  **代入约束**：我们将步骤1中得到的边界条件和步骤2中的约束关系代入：
    -   $\vec{C}_1 = \vec{P}_{en} + (k R_2) \cdot \vec{N}_{en}$ (其中 $k=2$)
    -   $\vec{C}_2 = \vec{P}_{ex} + R_2 \cdot \vec{N}_{ex}$
    -   $R_1+R_2 = (k+1)R_2$

2.  **定义常量向量**：为了使推导清晰，我们首先定义两个由边界条件决定的常量向量：
    -   $\Delta\vec{P} = \vec{P}_{en} - \vec{P}_{ex}$
    -   $\Delta\vec{N} = k \vec{N}_{en} - \vec{N}_{ex}$

3.  **化简主方程**：代入后，主方程的左侧变为 $|\Delta\vec{P} + R_2 \Delta\vec{N}|^2$。利用向量模平方等于自身点积的性质 $(|\vec{v}|^2 = \vec{v} \cdot \vec{v})$ 展开：
    $$|\Delta\vec{P}|^2 + 2 R_2 (\Delta\vec{P} \cdot \Delta\vec{N}) + R_2^2 |\Delta\vec{N}|^2 = ((k+1)R_2)^2$$

4.  **整理为标准形式**：将所有项移到一边，我们得到一个关于 $R_2$ 的**一元二次方程** $A R_2^2 + B R_2 + C = 0$：
    $$\left( |\Delta\vec{N}|^2 - (k+1)^2 \right) R_2^2 + \left( 2 \Delta\vec{P} \cdot \Delta\vec{N} \right) R_2 + |\Delta\vec{P}|^2 = 0$$

#### b. 直接计算半径

这是一个标准的一元二次方程，其系数A, B, C均为可以通过步骤1得到的常量计算出的具体数值：
-   $A = |\Delta\vec{N}|^2 - (k+1)^2$
-   $B = 2 (\Delta\vec{P} \cdot \Delta\vec{N})$
-   $C = |\Delta\vec{P}|^2$

因此，我们可以直接使用**求根公式**来解出 $R_2$：
$$R_2 = \frac{-B \pm \sqrt{B^2 - 4AC}}{2A}$$

**注意**：求出的解需要经过筛选，只有**正实数解**才具有物理意义。若出现两个正实数解，则需要进一步的几何检验来判断哪一个符合S形曲线的构造。

#### c. 计算完整几何参数与总弧长

1.  **求解半径和圆心**:
    -   得到唯一的物理可行解 $R_2$ 后，计算 $R_1 = k R_2$。
    -   将 $R_1, R_2$ 代入步骤2的公式，计算出圆心 $\vec{C}_1, \vec{C}_2$ 的精确坐标。

2.  **求解圆心角**:
    -   计算两圆弧的连接切点 $\vec{P}_{mid} = \vec{C}_1 + R_1 \frac{\vec{C}_2 - \vec{C}_1}{|\vec{C}_2 - \vec{C}_1|}$。
    -   通过向量点积和反余弦函数计算圆心角：
        -   $\alpha_1 = \arccos\left(\frac{(\vec{P}_{en} - \vec{C}_1) \cdot (\vec{P}_{mid} - \vec{C}_1)}{R_1^2}\right)$
        -   $\alpha_2 = \arccos\left(\frac{(\vec{P}_{mid} - \vec{C}_2) \cdot (\vec{P}_{ex} - \vec{C}_2)}{R_2^2}\right)$
3.  **计算总弧长**:
    -   $L_{total} = \alpha_1 R_1 + \alpha_2 R_2$


### 步骤4：在复合轨道上进行运动模拟

在步骤3中，我们已经通过直接求解的方式，精确计算出了S形调头路径的所有几何参数（$R_1, R_2, \vec{C}_1, \vec{C}_2, \alpha_1, \alpha_2, L_{total}$）。现在，我们将这条由“盘入螺线 - 圆弧1 - 圆弧2 - 盘出螺线”四段构成的复合轨道作为**固定路径**，来模拟板凳龙从调头前100秒到调头后100秒的完整运动过程。

#### a. 构建统一的路径参数化函数

为了能方便地处理这条分段路径，我们首先建立一个**全局弧长坐标 `s`**，并编写一个函数，该函数能将任意的 `s` 值映射到轨道上的具体坐标和切线方向。

1.  **定义全局弧长 `s`**：
    -   令S形曲线的入口切点 $\vec{P}_{en}$ 处为 $s=0$。
    -   盘入螺线区域对应 $s < 0$。
    -   S形曲线区域的第一段圆弧对应 $0 \le s < \alpha_1 R_1$。
    -   S形曲线区域的第二段圆弧对应 $\alpha_1 R_1 \le s \le L_{total}$。
    -   盘出螺线区域对应 $s > L_{total}$。

2.  **函数 `get_path_info(s)`**:
    -   **输入**：全局弧长 `s`。
    -   **路径判断**：函数内部使用 `if/elif/else` 结构，根据 `s` 的值判断其所在的路径分段。
        -   `if s < 0` (在盘入螺线上): 根据弧长 `s` 反解出盘入螺线对应的极角 $\theta$，进而计算坐标和切向量。
        -   `elif 0 <= s < L_arc1` (在第一段圆弧上): 使用步骤3中求出的 $R_1, \vec{C}_1$，根据弧长 `s` 计算出在该圆弧上的坐标和切向量。
        -   `elif L_arc1 <= s <= L_total` (在第二段圆弧上): 使用步骤3中求出的 $R_2, \vec{C}_2$，根据弧长 `s - L_arc1` 计算出在该圆弧上的坐标和切向量。
        -   `else` (即 `s > L_total`, 进入盘出螺线): 利用**中心对称**性质进行计算。
            i.  计算超出S曲线的弧长：`d = s - L_total`。
            ii. 找到盘入螺线上对称的弧长点：`s_symmetric = -d`。
            iii. 计算该对称点的信息：`info_symmetric = get_path_info(s_symmetric)`。
            iv. 盘出螺线上的点是中心对称点：`position = -info_symmetric.position`。
            v.  其切向量同样中心对称：`tangent = -info_symmetric.tangent`。
    -   **输出**：一个包含位置和方向的结构体，例如：`{ position: (x, y), tangent: (Tx, Ty) }`。

#### b. 初始化模拟状态 (t = -100s)

1.  **确定龙头初始位置**:
    -   根据题意，$t=0$ 是调头开始的时刻，龙头位于 $s=0$。
    -   由于龙头速度为 $1\text{m/s}$，因此在 $t=-100\text{s}$ 时，它的全局弧长坐标为 $s_0(-100) = 0 - 1 \times 100 = -100$。
    -   计算龙头的初始坐标 $\vec{P}_0(-100) = \text{get\_path\_info}(-100)\text{.position}$。
2.  **确定后续把手初始位置 (递推求解)**:
    -   建立一个从 `i=1` 到 `223` 的循环，依次求解后续把手的初始弧长 $s_i(-100)$。
    -   在循环的第 `i` 步，已知前一节把手的位置 $\vec{P}_{i-1}(-100)$。我们需要找到一个弧长 `s`，使其对应的点与 $\vec{P}_{i-1}$ 的直线距离等于板凳长度 $L_i$。
    -   这需要调用一个**数值求根算法**，求解方程：
        $$|\text{get\_path\_info}(s)\text{.position} - \vec{P}_{i-1}(-100)|^2 - L_i^2 = 0$$
    -   该方程的根 `s` 就是我们要求的 $s_i(-100)$。

#### c. 执行时间推进循环 (t 从 -99s 到 100s)

1.  **外层时间循环**: `for t in -99, -98, ..., 100:`
2.  **更新龙头位置 ($P_0$)**:
    -   龙头的弧长位置每次增加1米：$s_0(t) = s_0(t-1) + 1$。
    -   计算龙头新坐标 $\vec{P}_0(t) = \text{get\_path\_info}(s_0(t))\text{.position}$。
3.  **更新后续把手位置 (内层递推循环)**: `for i in 1 to 223:`
    -   获取刚计算出的前一个把手的位置 $\vec{P}_{i-1}(t)$。
    -   再次调用**数值求根算法**，求解与初始化步骤中完全相同的方程，以找到当前把手的弧长 $s_i(t)$：
        $$|\text{get\_path\_info}(s)\text{.position} - \vec{P}_{i-1}(t)|^2 - L_i^2 = 0$$
    -   得到 $s_i(t)$ 后，计算其坐标 $\vec{P}_i(t) = \text{get\_path\_info}(s_i(t))\text{.position}$。

#### d. 计算所有把手的速度

-   在时刻 `t`，当所有224个把手的位置（即所有 $s_i(t)$）都计算完毕后，使用第一问修正后的**速度递推公式**计算所有把手的速度大小 $v_i(t)$ 和速度向量 $\vec{v}_i(t)$。
    $$v_i = v_{i-1} \frac{\vec{T}(s_{i-1}) \cdot \vec{u}_{L_i}}{\vec{T}(s_i) \cdot \vec{u}_{L_i}}$$
    其中单位切向量 $\vec{T}(s)$ 由 `get_path_info(s)` 函数提供，板凳单位向量 $\vec{u}_{L_i}$ 由当前时刻的把手位置计算得出。
-   最终速度向量为 $\vec{v}_i(t) = v_i(t) \cdot \text{get\_path\_info}(s_i(t))\text{.tangent}$。

## 结果数据需求
- 最终的数据包括：
    -   圆心坐标 $\vec{C}_1, \vec{C}_2$
    -   半径 $R_1, R_2$
    -   圆心角 $\alpha_1, \alpha_2$
    -   总弧长 $L_{total}$
    -   -100s到100s的所有把手位置和速度信息

## 模型求解方法需求
无特殊求解方法需求，对于数值求根算法依然还是使用numba加速